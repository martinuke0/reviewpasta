---
phase: 01-foundation-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified: [src/worker.ts, wrangler.toml, package.json]
autonomous: false
user_setup:
  - service: cloudflare
    why: "Pages and Workers deployment"
    env_vars: []
    dashboard_config:
      - task: "Note account ID from Cloudflare dashboard"
        location: "Cloudflare Dashboard -> Right sidebar -> Account ID"

must_haves:
  truths:
    - "Workers project can handle API requests"
    - "Pages project configured for frontend"
    - "Git integration connected for auto-deploy"
  artifacts:
    - path: "src/worker.ts"
      provides: "Workers API handler"
      min_lines: 20
      exports: ["default"]
    - path: "wrangler.toml"
      provides: "Complete Workers and Pages config"
      contains: "pages_build_output_dir"
  key_links:
    - from: "src/worker.ts"
      to: "D1 database"
      via: "env.DB binding"
      pattern: "env\\.DB"
    - from: "wrangler.toml"
      to: "dist folder"
      via: "pages_build_output_dir"
      pattern: "pages_build_output_dir.*=.*\"dist\""
---

<objective>
Configure Cloudflare Workers for API and Pages for frontend deployment

Purpose: Set up the runtime infrastructure for both API and frontend
Output: Working Workers script, Pages configuration, git auto-deploy
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-foundation-setup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Workers API handler</name>
  <files>src/worker.ts</files>
  <action>
    Create a basic Workers script that will handle API routes:
    1. Create `src/worker.ts` with:
       - Export default handler for fetch events
       - Basic routing structure for /api/* paths
       - CORS headers for cross-origin requests
       - Connection to D1 database via env.DB
       - Placeholder routes: GET /api/businesses, POST /api/businesses, GET /api/businesses/:slug
       - Error handling with proper status codes

    Example structure:
    ```typescript
    export default {
      async fetch(request: Request, env: Env): Promise<Response> {
        const url = new URL(request.url);

        // Enable CORS
        const headers = {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type',
        };

        if (request.method === 'OPTIONS') {
          return new Response(null, { headers });
        }

        // Route API calls
        if (url.pathname.startsWith('/api/')) {
          // Placeholder routing logic
        }

        return new Response('Not Found', { status: 404, headers });
      }
    };
    ```

    The script should be TypeScript and use Workers Types for proper typing.
  </action>
  <verify>File exists at src/worker.ts with export default handler</verify>
  <done>Workers script created with basic API structure and D1 binding</done>
</task>

<task type="auto">
  <name>Task 2: Configure Pages in wrangler.toml</name>
  <files>wrangler.toml, package.json</files>
  <action>
    Update wrangler.toml for Pages deployment and add build scripts:
    1. Add to wrangler.toml:
       - pages_build_output_dir = "dist"
       - Add [site] section if using Workers Sites
       - Ensure compatibility_date is set to today

    2. Update package.json scripts:
       - Add "deploy:worker": "wrangler deploy"
       - Add "deploy:pages": "npm run build && wrangler pages deploy dist"
       - Add "dev:worker": "wrangler dev"

    3. Run `npx wrangler pages project create reviewpasta` to create Pages project
    4. Connect git repository: `npx wrangler pages project create reviewpasta --production-branch main`
       Note: This may require manual configuration in Cloudflare dashboard for git integration
  </action>
  <verify>npx wrangler pages project list shows reviewpasta project</verify>
  <done>Pages project created and wrangler.toml updated with Pages configuration</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Workers API handler and Pages project configuration</what-built>
  <how-to-verify>
    1. Check Workers script exists: ls src/worker.ts
    2. Verify Pages project: npx wrangler pages project list
    3. Check wrangler.toml has both Workers and Pages config
    4. Verify git integration in Cloudflare dashboard:
       - Go to https://dash.cloudflare.com
       - Navigate to Workers & Pages -> reviewpasta
       - Check Settings -> Builds & deployments
       - Confirm git repository is connected
  </how-to-verify>
  <resume-signal>Type "approved" if configuration looks correct, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Workers script exists: `ls src/worker.ts`
2. Pages project exists: `npx wrangler pages project list`
3. Build succeeds: `npm run build`
4. wrangler.toml has complete configuration
</verification>

<success_criteria>
- Workers script handles basic API routing
- Pages project created in Cloudflare
- Build output configured to dist folder
- Git integration ready for auto-deploy
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-setup/01-02-SUMMARY.md`
</output>